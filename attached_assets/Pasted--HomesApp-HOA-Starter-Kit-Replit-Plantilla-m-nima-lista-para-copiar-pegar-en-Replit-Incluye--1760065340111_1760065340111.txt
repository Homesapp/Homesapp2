# HomesApp HOA Starter Kit (Replit)

Plantilla mÃ­nima lista para copiar/pegar en Replit. Incluye **API Node/Express (TypeScript)** + **Prisma (PostgreSQL)** + mÃ³dulos base para **condominios, unidades, cuotas, pagos e incidencias**.

> **CÃ³mo usar**: crea un proyecto, replica esta estructura (carpetas/archivos) y pega cada contenido. Luego sigue los pasos de **Quick Start**.

---

## ðŸ“ Estructura de carpetas

```
/api
  package.json
  tsconfig.json
  .env.example
  /prisma
    schema.prisma
    seed.ts
  /src
    index.ts
    /config
      env.ts
    /middleware
      auth.ts
      errorHandler.ts
      rateLimit.ts
    /modules
      /auth
        auth.routes.ts
        auth.service.ts
      /condos
        condos.routes.ts
        condos.service.ts
      /units
        units.routes.ts
        units.service.ts
      /fees
        fees.routes.ts
        fees.service.ts
      /payments
        payments.routes.ts
        payments.service.ts
      /issues
        issues.routes.ts
        issues.service.ts
```

---

## ðŸ“¦ `/api/package.json`

```json
{
  "name": "homesapp-hoa-api",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "prisma": "prisma",
    "db:push": "prisma db push",
    "db:migrate": "prisma migrate dev --name init",
    "db:seed": "tsx prisma/seed.ts"
  },
  "dependencies": {
    "@prisma/client": "^5.20.0",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "express-rate-limit": "^7.2.0",
    "helmet": "^7.1.0",
    "jsonwebtoken": "^9.0.2",
    "pino": "^9.3.2",
    "pino-http": "^9.0.0"
  },
  "devDependencies": {
    "prisma": "^5.20.0",
    "tsx": "^4.19.1",
    "typescript": "^5.6.3"
  }
}
```

---

## ðŸ§° `/api/tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "moduleResolution": "Bundler",
    "outDir": "dist",
    "rootDir": "src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  },
  "include": ["src"]
}
```

---

## ðŸ” `/api/.env.example`

```
PORT=3000
JWT_SECRET=cambia_esta_llave_super_larga
DATABASE_URL=postgresql://user:pass@host:5432/homesapp
ALLOWED_ORIGINS=http://localhost:5173,https://property-flow-administracio48.replit.app
APP_VERSION=0.1.0
```

> En Replit: **Secrets** â†’ crea estas variables. Nunca subas `.env` al repo.

---

## ðŸ—ƒï¸ `/api/prisma/schema.prisma`

```prisma
// Prisma schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role { ADMIN PROPIETARIO STAFF PROVEEDOR }

enum IssueStatus { PENDIENTE EN_PROCESO RESUELTO }

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(PROPIETARIO)
  createdAt DateTime @default(now())
  units     Unit[]   @relation("OwnerUnits")
}

model Condo {
  id        String   @id @default(cuid())
  name      String
  address   String?
  createdAt DateTime @default(now())
  units     Unit[]
}

model Unit {
  id        String   @id @default(cuid())
  number    String
  condo     Condo    @relation(fields: [condoId], references: [id])
  condoId   String
  owner     User?    @relation("OwnerUnits", fields: [ownerId], references: [id])
  ownerId   String?
  occupants User[]   @relation("Occupants")
  fees      Fee[]
  payments  Payment[]
  issues    Issue[]
}

model Fee {
  id        String   @id @default(cuid())
  unit      Unit     @relation(fields: [unitId], references: [id])
  unitId    String
  month     Int
  year      Int
  amount    Decimal  @db.Decimal(10,2)
  dueDate   DateTime
  createdAt DateTime @default(now())
}

model Payment {
  id        String   @id @default(cuid())
  unit      Unit     @relation(fields: [unitId], references: [id])
  unitId    String
  amount    Decimal  @db.Decimal(10,2)
  method    String
  paidAt    DateTime
  receipt   String?
  createdAt DateTime @default(now())
}

model Issue {
  id        String    @id @default(cuid())
  unit      Unit?     @relation(fields: [unitId], references: [id])
  unitId    String?
  condo     Condo?    @relation(fields: [condoId], references: [id])
  condoId   String?
  title     String
  detail    String?
  status    IssueStatus @default(PENDIENTE)
  photos    Json?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}
```

---

## ðŸŒ± `/api/prisma/seed.ts`

```ts
import { PrismaClient, Role } from "@prisma/client";
import bcrypt from "bcryptjs";

const prisma = new PrismaClient();

async function main() {
  const adminPass = await bcrypt.hash("admin123", 10);
  const admin = await prisma.user.upsert({
    where: { email: "admin@hoa.local" },
    update: {},
    create: { email: "admin@hoa.local", password: adminPass, role: Role.ADMIN },
  });

  const condo = await prisma.condo.create({ data: { name: "Condominio Central", address: "Tulum, Q.Roo" } });
  const unitA = await prisma.unit.create({ data: { number: "A-101", condoId: condo.id, ownerId: admin.id } });

  await prisma.fee.create({
    data: { unitId: unitA.id, month: 10, year: 2025, amount: "2500.00", dueDate: new Date() }
  });

  console.log({ admin, condo });
}

main().finally(async () => prisma.$disconnect());
```

> **Nota**: aÃ±ade `bcryptjs` a dependencias si vas a usar este seed (`npm i bcryptjs`). Si prefieres no usar seed con hash, coloca password plano y elimina bcrypt.

---

## ðŸš€ `/api/src/index.ts`

```ts
import "dotenv/config";
import express from "express";
import helmet from "helmet";
import cors from "cors";
import rateLimit from "express-rate-limit";
import pino from "pino";
import pinoHttp from "pino-http";
import { authRouter } from "./modules/auth/auth.routes";
import { condosRouter } from "./modules/condos/condos.routes";
import { unitsRouter } from "./modules/units/units.routes";
import { feesRouter } from "./modules/fees/fees.routes";
import { paymentsRouter } from "./modules/payments/payments.routes";
import { issuesRouter } from "./modules/issues/issues.routes";
import { errorHandler } from "./middleware/errorHandler";

const app = express();
const logger = pino();
app.use(pinoHttp({ logger }));

app.use(express.json({ limit: "1mb" }));
app.use(helmet());
app.use(cors({ origin: process.env.ALLOWED_ORIGINS?.split(",") || true }));

const apiLimiter = rateLimit({ windowMs: 15 * 60 * 1000, max: 200 });
const authLimiter = rateLimit({ windowMs: 15 * 60 * 1000, max: 20 });
app.use("/api", apiLimiter);
app.use("/api/auth", authLimiter);

app.get("/health", (_req, res) => {
  res.json({ ok: true, service: "homesapp-api", version: process.env.APP_VERSION || "dev", ts: new Date().toISOString() });
});

app.use("/api/auth", authRouter);
app.use("/api/condos", condosRouter);
app.use("/api/units", unitsRouter);
app.use("/api/fees", feesRouter);
app.use("/api/payments", paymentsRouter);
app.use("/api/issues", issuesRouter);

app.use(errorHandler);

const port = Number(process.env.PORT || 3000);
app.listen(port, () => logger.info(`API running on :${port}`));
```

---

## âš™ï¸ `/api/src/config/env.ts`

```ts
export const config = {
  port: Number(process.env.PORT || 3000),
  jwtSecret: process.env.JWT_SECRET || "change_me",
};
```

---

## ðŸ›¡ï¸ `/api/src/middleware/auth.ts`

```ts
import { Request, Response, NextFunction } from "express";
import jwt from "jsonwebtoken";

export function requireAuth(req: Request, res: Response, next: NextFunction) {
  const hdr = req.headers.authorization || "";
  const token = hdr.startsWith("Bearer ") ? hdr.slice(7) : null;
  if (!token) return res.status(401).json({ message: "No token" });
  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET!);
    (req as any).user = payload;
    next();
  } catch {
    res.status(401).json({ message: "Invalid token" });
  }
}

export function requireRole(...roles: string[]) {
  return (req: Request, res: Response, next: NextFunction) => {
    const user = (req as any).user;
    if (!user) return res.status(401).json({ message: "Unauthenticated" });
    if (!roles.includes(user.role)) return res.status(403).json({ message: "Forbidden" });
    next();
  };
}
```

---

## ðŸ§¯ `/api/src/middleware/errorHandler.ts`

```ts
import { Request, Response, NextFunction } from "express";

export function errorHandler(err: any, _req: Request, res: Response, _next: NextFunction) {
  const status = err?.status || 500;
  const message = err?.message || "Internal Error";
  res.status(status).json({ error: true, message });
}
```

---

## ðŸš¦ `/api/src/middleware/rateLimit.ts`

```ts
import rateLimit from "express-rate-limit";

export const defaultLimiter = rateLimit({ windowMs: 15 * 60 * 1000, max: 200 });
export const authLimiter = rateLimit({ windowMs: 15 * 60 * 1000, max: 20 });
```

---

## ðŸ‘¤ `/api/src/modules/auth/auth.service.ts`

```ts
import { PrismaClient } from "@prisma/client";
import jwt from "jsonwebtoken";
import bcrypt from "bcryptjs";

const prisma = new PrismaClient();

export async function login(email: string, password: string) {
  const user = await prisma.user.findUnique({ where: { email } });
  if (!user) throw { status: 401, message: "Credenciales invÃ¡lidas" };
  const ok = await bcrypt.compare(password, user.password);
  if (!ok) throw { status: 401, message: "Credenciales invÃ¡lidas" };
  const token = jwt.sign({ sub: user.id, role: user.role, email: user.email }, process.env.JWT_SECRET!, { expiresIn: "30m" });
  const refresh = jwt.sign({ sub: user.id }, process.env.JWT_SECRET!, { expiresIn: "7d" });
  return { token, refresh, user: { id: user.id, role: user.role, email: user.email } };
}
```

---

## ðŸ”‘ `/api/src/modules/auth/auth.routes.ts`

```ts
import { Router } from "express";
import { login } from "./auth.service";

export const authRouter = Router();

authRouter.post("/login", async (req, res, next) => {
  try {
    const { email, password } = req.body;
    const data = await login(email, password);
    res.json(data);
  } catch (e) { next(e); }
});
```

---

## ðŸ¢ `/api/src/modules/condos/condos.service.ts`

```ts
import { PrismaClient } from "@prisma/client";
const prisma = new PrismaClient();

export function list() { return prisma.condo.findMany(); }
export function create(data: { name: string; address?: string }) { return prisma.condo.create({ data }); }
```

## ðŸ¢ `/api/src/modules/condos/condos.routes.ts`

```ts
import { Router } from "express";
import { requireAuth, requireRole } from "../../middleware/auth";
import * as svc from "./condos.service";

export const condosRouter = Router();
condosRouter.use(requireAuth);

condosRouter.get("/", requireRole("ADMIN","STAFF"), async (_req, res) => {
  res.json(await svc.list());
});

condosRouter.post("/", requireRole("ADMIN"), async (req, res) => {
  const c = await svc.create(req.body);
  res.status(201).json(c);
});
```

---

## ðŸ  `/api/src/modules/units/units.service.ts`

```ts
import { PrismaClient } from "@prisma/client";
const prisma = new PrismaClient();

export function list(condoId?: string) {
  return prisma.unit.findMany({ where: { condoId } });
}
export function create(data: { number: string; condoId: string; ownerId?: string }) {
  return prisma.unit.create({ data });
}
```

## ðŸ  `/api/src/modules/units/units.routes.ts`

```ts
import { Router } from "express";
import { requireAuth, requireRole } from "../../middleware/auth";
import * as svc from "./units.service";

export const unitsRouter = Router();
unitsRouter.use(requireAuth);

unitsRouter.get("/", requireRole("ADMIN","STAFF"), async (req, res) => {
  res.json(await svc.list(req.query.condoId as string | undefined));
});

unitsRouter.post("/", requireRole("ADMIN"), async (req, res) => {
  const u = await svc.create(req.body);
  res.status(201).json(u);
});
```

---

## ðŸ’¸ `/api/src/modules/fees/fees.service.ts`

```ts
import { PrismaClient } from "@prisma/client";
const prisma = new PrismaClient();

export function upsertFee(data: { unitId: string; month: number; year: number; amount: string; dueDate: string }) {
  return prisma.fee.upsert({
    where: { unitId_month_year: { unitId: data.unitId, month: data.month, year: data.year } },
    update: { amount: data.amount, dueDate: new Date(data.dueDate) },
    create: { ...data, dueDate: new Date(data.dueDate) }
  });
}

export function listUnitFees(unitId: string) { return prisma.fee.findMany({ where: { unitId } }); }
```

> **Ãndice compuesto**: aÃ±ade en `schema.prisma` si quieres evitar duplicados:
>
> ```prisma
> @@unique([unitId, month, year], name: "unitId_month_year")
> ```

## ðŸ’¸ `/api/src/modules/fees/fees.routes.ts`

```ts
import { Router } from "express";
import { requireAuth, requireRole } from "../../middleware/auth";
import * as svc from "./fees.service";

export const feesRouter = Router();
feesRouter.use(requireAuth);

feesRouter.post("/upsert", requireRole("ADMIN","STAFF"), async (req, res, next) => {
  try { res.json(await svc.upsertFee(req.body)); } catch (e) { next(e); }
});

feesRouter.get("/unit/:id", requireRole("ADMIN","STAFF","PROPIETARIO"), async (req, res) => {
  res.json(await svc.listUnitFees(req.params.id));
});
```

---

## ðŸ’³ `/api/src/modules/payments/payments.service.ts`

```ts
import { PrismaClient } from "@prisma/client";
const prisma = new PrismaClient();

export function create(data: { unitId: string; amount: string; method: string; paidAt?: string; receipt?: string }) {
  return prisma.payment.create({ data: { ...data, paidAt: data.paidAt ? new Date(data.paidAt) : new Date() } });
}

export function listUnitPayments(unitId: string) { return prisma.payment.findMany({ where: { unitId } }); }
```

## ðŸ’³ `/api/src/modules/payments/payments.routes.ts`

```ts
import { Router } from "express";
import { requireAuth, requireRole } from "../../middleware/auth";
import * as svc from "./payments.service";

export const paymentsRouter = Router();
paymentsRouter.use(requireAuth);

paymentsRouter.post("/", requireRole("ADMIN","STAFF"), async (req, res, next) => {
  try { res.status(201).json(await svc.create(req.body)); } catch (e) { next(e); }
});

paymentsRouter.get("/unit/:id", requireRole("ADMIN","STAFF","PROPIETARIO"), async (req, res) => {
  res.json(await svc.listUnitPayments(req.params.id));
});
```

---

## ðŸ§° `/api/src/modules/issues/issues.service.ts`

```ts
import { PrismaClient, IssueStatus } from "@prisma/client";
const prisma = new PrismaClient();

export function report(data: { title: string; detail?: string; unitId?: string; condoId?: string; photos?: any }) {
  return prisma.issue.create({ data });
}

export function list(filter: { status?: IssueStatus; condoId?: string; unitId?: string } = {}) {
  return prisma.issue.findMany({ where: filter });
}

export function updateStatus(id: string, status: IssueStatus) {
  return prisma.issue.update({ where: { id }, data: { status } });
}
```

## ðŸ§° `/api/src/modules/issues/issues.routes.ts`

```ts
import { Router } from "express";
import { requireAuth, requireRole } from "../../middleware/auth";
import * as svc from "./issues.service";

export const issuesRouter = Router();
issuesRouter.use(requireAuth);

issuesRouter.post("/", requireRole("ADMIN","STAFF","PROPIETARIO"), async (req, res, next) => {
  try { res.status(201).json(await svc.report(req.body)); } catch (e) { next(e); }
});

issuesRouter.get("/", requireRole("ADMIN","STAFF"), async (req, res) => {
  res.json(await svc.list(req.query as any));
});

issuesRouter.patch("/:id/status", requireRole("ADMIN","STAFF"), async (req, res, next) => {
  try { res.json(await svc.updateStatus(req.params.id, req.body.status)); } catch (e) { next(e); }
});
```

---

## ðŸ Quick Start (Replit)

1. **Crear proyecto** y carpeta `/api`. Copia los archivos anteriores en su ruta.
2. En **Secrets** agrega variables de `.env.example`.
3. Instala dependencias en shell de Replit:

   ```bash
   npm i
   ```
4. Inicializa la base de datos:

   ```bash
   npx prisma generate
   npm run db:push
   npm run db:seed   # opcional
   ```
5. Corre la API en dev:

   ```bash
   npm run dev
   ```
6. Prueba endpoints (ej.):

   * `GET /health`
   * `POST /api/auth/login` `{ email, password }`
   * `GET /api/condos` (con Bearer token)

> Siguiente paso: conectar tu frontend (panel) y empezar a consumir `/api/*`.

---

## âœ… Siguientes mejoras sugeridas

* AÃ±adir **PDF de recibos** (puppeteer/pdfkit) y carga a bucket.
* Crear **morosidad** por unidad (saldo = Î£cuotas âˆ’ Î£pagos).
* Integrar **WhatsApp API** para recordatorios.
* AÃ±adir **encuestas/actas** con firma digital.

---

Â¿Quieres que te agregue un **frontend React** mÃ­nimo (Dashboard + Finance + Maintenance) para consumir esta API? Puedo sumarlo aquÃ­ mismo.
